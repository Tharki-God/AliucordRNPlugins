"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const core_1 = require("@swc/core");
const pluginutils_1 = require("@rollup/pluginutils");
const path_1 = require("path");
const fs_1 = require("fs");
const resolveFilename = async (basename) => {
    for (const extension of ['js', 'jsx', 'ts', 'tsx']) {
        const possibleFilename = `${basename}.${extension}`;
        try {
            await fs_1.promises.access(possibleFilename);
            return possibleFilename;
        }
        catch { }
    }
    return null;
};
const swc = (pluginOptions = {}) => {
    const { rollup, ...options } = pluginOptions;
    const filter = (0, pluginutils_1.createFilter)(rollup?.include, rollup?.exclude);
    return {
        name: 'swc',
        async resolveId(source, importer) {
            if (importer === undefined || !(source.startsWith('.') || (0, path_1.isAbsolute)(source))) {
                return null;
            }
            const filename = (0, path_1.resolve)((0, path_1.dirname)(importer), source);
            try {
                return (await fs_1.promises.stat(filename)).isDirectory()
                    ? await resolveFilename((0, path_1.join)(filename, 'index'))
                    : filename;
            }
            catch {
                return await resolveFilename(filename);
            }
        },
        transform(code, filename) {
            if (!filter(filename)) {
                return null;
            }
            options.filename = filename;
            return (0, core_1.transform)(code, options);
        },
    };
};
exports.default = swc;
